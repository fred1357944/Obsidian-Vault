/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __defNormalProp = (obj, key, value) => key in obj ? __defProp(obj, key, { enumerable: true, configurable: true, writable: true, value }) : obj[key] = value;
var __markAsModule = (target) => __defProp(target, "__esModule", { value: true });
var __export = (target, all) => {
  __markAsModule(target);
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __reExport = (target, module2, desc) => {
  if (module2 && typeof module2 === "object" || typeof module2 === "function") {
    for (let key of __getOwnPropNames(module2))
      if (!__hasOwnProp.call(target, key) && key !== "default")
        __defProp(target, key, { get: () => module2[key], enumerable: !(desc = __getOwnPropDesc(module2, key)) || desc.enumerable });
  }
  return target;
};
var __toModule = (module2) => {
  return __reExport(__markAsModule(__defProp(module2 != null ? __create(__getProtoOf(module2)) : {}, "default", module2 && module2.__esModule && "default" in module2 ? { get: () => module2.default, enumerable: true } : { value: module2, enumerable: true })), module2);
};
var __publicField = (obj, key, value) => {
  __defNormalProp(obj, typeof key !== "symbol" ? key + "" : key, value);
  return value;
};

// src/main.ts
__export(exports, {
  default: () => SettingsSearch
});
var import_obsidian = __toModule(require("obsidian"));

// node_modules/monkey-around/mjs/index.js
function around(obj, factories) {
  const removers = Object.keys(factories).map((key) => around1(obj, key, factories[key]));
  return removers.length === 1 ? removers[0] : function() {
    removers.forEach((r) => r());
  };
}
function around1(obj, method, createWrapper) {
  const original = obj[method], hadOwn = obj.hasOwnProperty(method);
  let current = createWrapper(original);
  if (original)
    Object.setPrototypeOf(current, original);
  Object.setPrototypeOf(wrapper, current);
  obj[method] = wrapper;
  return remove;
  function wrapper(...args) {
    if (current === original && obj[method] === wrapper)
      remove();
    return current.apply(this, args);
  }
  function remove() {
    if (obj[method] === wrapper) {
      if (hadOwn)
        obj[method] = original;
      else
        delete obj[method];
    }
    if (current === original)
      return;
    current = original;
    Object.setPrototypeOf(wrapper, original || Function);
  }
}

// src/main.ts
var SettingsSearch = class extends import_obsidian.Plugin {
  constructor() {
    super(...arguments);
    __publicField(this, "settingsSearchEl", createDiv("settings-search-container vertical-tab-header-group"));
    __publicField(this, "settingsResultsContainerEl", createDiv("settings-search-results-container vertical-tab-content"));
    __publicField(this, "settingsNavItemContainer", this.settingsSearchEl.createDiv("vertical-tab-header-group-items").createDiv("vertical-tab-nav-item settings-search-input"));
    __publicField(this, "settingsResultsEl");
    __publicField(this, "search");
    __publicField(this, "locale");
    __publicField(this, "resources", []);
    __publicField(this, "results", []);
    __publicField(this, "tabIndex", 0);
    __publicField(this, "pluginTabIndex", 0);
    __publicField(this, "settingCache", new Map());
    __publicField(this, "searchAppended", false);
    __publicField(this, "activeIndex", -1);
    __publicField(this, "activeSetting");
    __publicField(this, "scope", new import_obsidian.Scope(this.app.scope));
  }
  async onload() {
    this.app.workspace.onLayoutReady(async () => {
      this.settingsResultsContainerEl.createEl("h3", {
        text: "Settings Search Results"
      });
      this.settingsResultsEl = this.settingsResultsContainerEl.createDiv("settings-search-results");
      this.buildScope();
      this.buildSearch();
      this.buildResources();
      this.buildPluginResources();
      this.patchSettings();
    });
  }
  buildResources() {
    const tab = this.app.setting.settingTabs[this.tabIndex];
    if (tab) {
      this.getTabResources(tab);
      this.tabIndex++;
      setImmediate(() => this.buildResources());
    }
  }
  buildPluginResources() {
    const tab = this.app.setting.pluginTabs[this.pluginTabIndex];
    if (tab) {
      this.getTabResources(tab);
      this.pluginTabIndex++;
      setImmediate(() => this.buildPluginResources());
    }
  }
  get manifests() {
    return Object.values(this.app.plugins.manifests);
  }
  addResourceToCache(resource) {
    const setting = new import_obsidian.Setting(createDiv()).setName(resource.text).setDesc(createFragment((e) => e.createDiv().innerHTML = resource.desc ?? ""));
    if (resource.tab == "community-plugins") {
      let plugin = this.manifests.find((p) => p.name == resource.text);
      if (plugin && this.app.plugins.getPlugin(plugin.id)?._loaded && this.app.setting.pluginTabs.find((t) => t.id == plugin.id)) {
        setting.addExtraButton((b) => {
          b.setTooltip(`Open ${resource.text} Settings`).onClick(() => {
            this.app.setting.openTabById(plugin.id);
          });
        });
      }
    }
    if (resource.tab == "plugins") {
      const plugins = Object.values(this.app.internalPlugins.plugins);
      const plugin = plugins.find((p) => p._loaded && p.instance.name == resource.text);
      if (plugin && this.app.setting.pluginTabs.find((t) => t.id == plugin.instance.id)) {
        setting.addExtraButton((b) => {
          b.setTooltip(`Open ${resource.text} Settings`).onClick(() => {
            this.app.setting.openTabById(plugin.instance.id);
          });
        });
      }
    }
    setting.addExtraButton((b) => {
      b.setIcon("forward-arrow").onClick(() => {
        this.showResult(resource);
      });
    });
    this.settingCache.set(resource.text, setting);
  }
  getResourceFromCache(resource) {
    if (!this.settingCache.has(resource.text)) {
      this.addResourceToCache(resource);
    }
    return this.settingCache.get(resource.text);
  }
  removeResourcesFromCache(resources) {
    for (const resource of resources) {
      this.settingCache.delete(resource.text);
    }
  }
  async getTabResources(tab) {
    await tab.display();
    const settings = tab.containerEl.querySelectorAll(".setting-item:not(.setting-item-header)");
    for (const el of Array.from(settings)) {
      const text = el.querySelector(".setting-item-name")?.textContent;
      if (!text)
        continue;
      const desc = el.querySelector(".setting-item-description")?.innerHTML ?? "";
      const resource = {
        tab: tab.id,
        name: tab.name,
        text,
        desc
      };
      this.resources.push(resource);
      this.addResourceToCache(resource);
    }
    if (this.app.setting.activeTab?.id == tab.id)
      return;
    tab.containerEl.detach();
    tab.hide();
  }
  patchSettings() {
    const self = this;
    this.register(around(this.app.setting, {
      onOpen: function(next) {
        return function() {
          next.apply(this);
          self.search.inputEl.focus();
          return next;
        };
      }
    }));
    this.register(around(this.app.setting, {
      addSettingTab: function(next) {
        return function(tab) {
          self.getTabResources(tab);
          return next.call(this, tab);
        };
      }
    }));
    this.register(around(this.app.setting, {
      removeSettingTab: function(next) {
        return function(tab) {
          if (this.isPluginSettingTab(tab)) {
            const removing = self.resources.filter((t) => t.tab == tab.id);
            self.resources = self.resources.filter((t) => t.tab != tab.id);
            self.removeResourcesFromCache(removing);
          }
          return next.call(this, tab);
        };
      }
    }));
    this.register(around(this.app.setting, {
      openTab: function(next) {
        return function(tab) {
          self.searchAppended = false;
          self.app.keymap.popScope(self.scope);
          console.log("\u{1F680} ~ file: main.ts ~ line 270 ~ popScope");
          return next.call(this, tab);
        };
      },
      openTabById: function(next) {
        return function(tab) {
          self.searchAppended = false;
          self.app.keymap.popScope(self.scope);
          console.log("\u{1F680} ~ file: main.ts ~ line 277 ~ popScope");
          return next.call(this, tab);
        };
      }
    }));
  }
  buildSearch() {
    const tempSetting = new import_obsidian.Setting(createDiv()).addSearch((s) => {
      this.search = s;
    });
    this.settingsNavItemContainer.append(tempSetting.controlEl);
    tempSetting.settingEl.detach();
    this.search.onChange((v) => {
      this.onChange(v);
    });
    this.search.setPlaceholder("Search settings...");
    this.app.setting.tabHeadersEl.prepend(this.settingsSearchEl);
  }
  buildScope() {
    this.scope.register([], "ArrowDown", () => {
      console.log("arrowdown");
      if (this.activeSetting) {
        this.activeSetting.settingEl.removeClass("active");
      }
      this.activeIndex = ((this.activeIndex + 1) % this.results.length + this.results.length) % this.results.length;
      this.centerActiveSetting();
    });
    this.scope.register([], "ArrowUp", () => {
      console.log("arrow up");
      if (this.activeSetting) {
        this.activeSetting.settingEl.removeClass("active");
      }
      this.activeIndex = ((this.activeIndex - 1) % this.results.length + this.results.length) % this.results.length;
      this.centerActiveSetting();
    });
    this.scope.register([], "Enter", () => {
      console.log("enter");
      if (this.activeSetting) {
        this.showResult(this.results[this.activeIndex]);
      }
    });
  }
  centerActiveSetting() {
    const result = this.results[this.activeIndex];
    this.activeSetting = this.getResourceFromCache(result);
    this.activeSetting.settingEl.addClass("active");
    this.activeSetting.settingEl.scrollIntoView({
      behavior: "auto",
      block: "nearest"
    });
  }
  onChange(v) {
    if (!v) {
      this.app.setting.openTabById(this.app.setting.lastTabId);
      this.searchAppended = false;
      this.app.keymap.popScope(this.scope);
      console.log("\u{1F680} ~ file: main.ts ~ line 355 ~ popScope");
      this.activeIndex = -1;
      return;
    }
    if (!this.searchAppended) {
      this.app.setting.activeTab.navEl.removeClass("is-active");
      this.app.setting.tabContentContainer.empty();
      this.app.setting.tabContentContainer.append(this.settingsResultsContainerEl);
      this.searchAppended = true;
      this.app.keymap.popScope(this.scope);
      this.app.keymap.pushScope(this.scope);
      console.log("\u{1F680} ~ file: main.ts ~ line 368 ~ pushScope");
    }
    this.appendResults(this.performFuzzySearch(v));
  }
  getMatchText(text, result) {
    const matchElements = {};
    return createFragment((content) => {
      for (let i = 0; i < text.length; i++) {
        let match = result.matches.find((m) => m[0] === i);
        if (match) {
          const index = result.matches.indexOf(match);
          if (!matchElements[index]) {
            matchElements[index] = createSpan("suggestion-highlight");
          }
          let element = matchElements[index];
          content.appendChild(element);
          element.appendText(text.substring(match[0], match[1]));
          i += match[1] - match[0] - 1;
          continue;
        }
        content.appendText(text[i]);
      }
    });
  }
  appendResults(results) {
    this.settingsResultsEl.empty();
    if (results.length) {
      const headers = {};
      for (const resource of results) {
        if (!(resource.tab in headers)) {
          headers[resource.tab] = this.settingsResultsEl.createDiv();
          new import_obsidian.Setting(headers[resource.tab]).setHeading().setName(resource.name);
        }
        const setting = this.getResourceFromCache(resource);
        headers[resource.tab].append(setting.settingEl);
      }
    } else {
      this.settingsResultsEl.setText("No results found :(");
    }
  }
  showResult(result) {
    this.search.setValue("");
    const tab = this.app.setting.settingTabs.find((t) => t.id == result.tab) ?? this.app.setting.pluginTabs.find((t) => t.id == result.tab);
    if (!tab) {
      new import_obsidian.Notice("There was an issue opening the setting tab.");
      return;
    }
    this.app.setting.openTabById(tab.id);
    this.app.keymap.popScope(this.scope);
    console.log("\u{1F680} ~ file: main.ts ~ line 435 ~ popScope");
    try {
      const names = tab.containerEl.querySelectorAll(".setting-item-name");
      const el = Array.from(names).find((n) => n.textContent == result.text);
      if (!el)
        return;
      const setting = el.closest(".setting-item");
      if (!setting)
        return;
      if (tab.id == "obsidian-style-settings") {
        let collapsed = setting.closest(".style-settings-container");
        let previous = collapsed?.previousElementSibling;
        while (previous != null && previous.hasClass("is-collapsed") && previous.hasClass("style-settings-heading")) {
          previous.removeClass("is-collapsed");
          collapsed = collapsed.parentElement?.closest(".style-settings-container");
          previous = collapsed?.previousElementSibling;
        }
      }
      let details = setting.closest("details");
      while (details) {
        details.setAttr("open", "open");
        details = details.parentElement?.closest("details");
      }
      setting.scrollIntoView(true);
      setting.addClass("is-flashing");
      this.registerInterval(window.setTimeout(() => setting.removeClass("is-flashing"), 3e3));
    } catch (e) {
      console.error(e);
    }
  }
  performFuzzySearch(input) {
    const results = [], hotkeys = [];
    for (const resource of this.resources) {
      let result = (0, import_obsidian.prepareSimpleSearch)(input)(resource.text) ?? (0, import_obsidian.prepareSimpleSearch)(input)(resource.desc);
      if (result) {
        if (resource.tab == "hotkeys") {
          hotkeys.push(resource);
        } else {
          results.push(resource);
        }
      }
    }
    this.results = [...results, ...hotkeys];
    return this.results;
  }
  onunload() {
    this.settingsSearchEl.detach();
    this.settingsResultsEl.detach();
    if (this.searchAppended)
      this.app.setting.openTabById(this.app.setting.lastTabId);
  }
};
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vLi4vR2l0SHViL1BlcnNvbmFsL29ic2lkaWFuLXNldHRpbmdzLXNlYXJjaC9zcmMvbWFpbi50cyIsICIuLi8uLi8uLi8uLi9HaXRIdWIvUGVyc29uYWwvb2JzaWRpYW4tc2V0dGluZ3Mtc2VhcmNoL25vZGVfbW9kdWxlcy9tb25rZXktYXJvdW5kL21qcy9pbmRleC5qcyJdLAogICJzb3VyY2VzQ29udGVudCI6IFsiaW1wb3J0IHtcclxuICAgIFBsdWdpbixcclxuICAgIFNlYXJjaENvbXBvbmVudCxcclxuICAgIFNldHRpbmcsXHJcbiAgICBTZWFyY2hSZXN1bHQsXHJcbiAgICBOb3RpY2UsXHJcbiAgICBwcmVwYXJlU2ltcGxlU2VhcmNoLFxyXG4gICAgU2V0dGluZ1RhYixcclxuICAgIFNjb3BlXHJcbn0gZnJvbSBcIm9ic2lkaWFuXCI7XHJcblxyXG5pbXBvcnQgeyBhcm91bmQgfSBmcm9tIFwibW9ua2V5LWFyb3VuZFwiO1xyXG5cclxuZGVjbGFyZSBtb2R1bGUgXCJvYnNpZGlhblwiIHtcclxuICAgIGludGVyZmFjZSBBcHAge1xyXG4gICAgICAgIGludGVybmFsUGx1Z2luczoge1xyXG4gICAgICAgICAgICBwbHVnaW5zOiBSZWNvcmQ8XHJcbiAgICAgICAgICAgICAgICBzdHJpbmcsXHJcbiAgICAgICAgICAgICAgICB7IF9sb2FkZWQ6IGJvb2xlYW47IGluc3RhbmNlOiB7IG5hbWU6IHN0cmluZzsgaWQ6IHN0cmluZyB9IH1cclxuICAgICAgICAgICAgPjtcclxuICAgICAgICB9O1xyXG4gICAgICAgIHBsdWdpbnM6IHtcclxuICAgICAgICAgICAgbWFuaWZlc3RzOiBSZWNvcmQ8c3RyaW5nLCBQbHVnaW5NYW5pZmVzdD47XHJcbiAgICAgICAgICAgIHBsdWdpbnM6IFJlY29yZDxzdHJpbmcsIFBsdWdpbj47XHJcbiAgICAgICAgICAgIGdldFBsdWdpbihpZDogc3RyaW5nKTogUGx1Z2luO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgc2V0dGluZzoge1xyXG4gICAgICAgICAgICBvbk9wZW4oKTogdm9pZDtcclxuXHJcbiAgICAgICAgICAgIG9wZW5UYWJCeUlkKGlkOiBzdHJpbmcpOiB2b2lkO1xyXG4gICAgICAgICAgICBvcGVuVGFiKHRhYjogU2V0dGluZ1RhYik6IHZvaWQ7XHJcblxyXG4gICAgICAgICAgICBpc1BsdWdpblNldHRpbmdUYWIodGFiOiBTZXR0aW5nVGFiKTogYm9vbGVhbjtcclxuICAgICAgICAgICAgYWRkU2V0dGluZ1RhYih0YWI6IFNldHRpbmdUYWIpOiB2b2lkO1xyXG4gICAgICAgICAgICByZW1vdmVTZXR0aW5nVGFiKHRhYjogU2V0dGluZ1RhYik6IHZvaWQ7XHJcblxyXG4gICAgICAgICAgICBhY3RpdmVUYWI6IFNldHRpbmdUYWI7XHJcbiAgICAgICAgICAgIGxhc3RUYWJJZDogc3RyaW5nO1xyXG5cclxuICAgICAgICAgICAgcGx1Z2luVGFiczogUGx1Z2luU2V0dGluZ1RhYltdO1xyXG4gICAgICAgICAgICBzZXR0aW5nVGFiczogU2V0dGluZ1RhYltdO1xyXG5cclxuICAgICAgICAgICAgdGFiQ29udGVudENvbnRhaW5lcjogSFRNTERpdkVsZW1lbnQ7XHJcbiAgICAgICAgICAgIHRhYkhlYWRlcnNFbDogSFRNTERpdkVsZW1lbnQ7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIGludGVyZmFjZSBQbHVnaW4ge1xyXG4gICAgICAgIF9sb2FkZWQ6IGJvb2xlYW47XHJcbiAgICB9XHJcbiAgICBpbnRlcmZhY2UgUGx1Z2luU2V0dGluZ1RhYiB7XHJcbiAgICAgICAgbmFtZTogc3RyaW5nO1xyXG4gICAgfVxyXG4gICAgaW50ZXJmYWNlIFNldHRpbmdUYWIge1xyXG4gICAgICAgIGlkOiBzdHJpbmc7XHJcbiAgICAgICAgbmFtZTogc3RyaW5nO1xyXG4gICAgICAgIG5hdkVsOiBIVE1MRWxlbWVudDtcclxuICAgIH1cclxufVxyXG5cclxuaW50ZXJmYWNlIFJlc291cmNlIHtcclxuICAgIHRhYjogc3RyaW5nO1xyXG4gICAgdGV4dDogc3RyaW5nO1xyXG4gICAgZGVzYzogc3RyaW5nO1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG59XHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNldHRpbmdzU2VhcmNoIGV4dGVuZHMgUGx1Z2luIHtcclxuICAgIHNldHRpbmdzU2VhcmNoRWw6IEhUTUxEaXZFbGVtZW50ID0gY3JlYXRlRGl2KFxyXG4gICAgICAgIFwic2V0dGluZ3Mtc2VhcmNoLWNvbnRhaW5lciB2ZXJ0aWNhbC10YWItaGVhZGVyLWdyb3VwXCJcclxuICAgICk7XHJcbiAgICBzZXR0aW5nc1Jlc3VsdHNDb250YWluZXJFbCA9IGNyZWF0ZURpdihcclxuICAgICAgICBcInNldHRpbmdzLXNlYXJjaC1yZXN1bHRzLWNvbnRhaW5lciB2ZXJ0aWNhbC10YWItY29udGVudFwiXHJcbiAgICApO1xyXG4gICAgc2V0dGluZ3NOYXZJdGVtQ29udGFpbmVyID0gdGhpcy5zZXR0aW5nc1NlYXJjaEVsXHJcbiAgICAgICAgLmNyZWF0ZURpdihcInZlcnRpY2FsLXRhYi1oZWFkZXItZ3JvdXAtaXRlbXNcIilcclxuICAgICAgICAuY3JlYXRlRGl2KFwidmVydGljYWwtdGFiLW5hdi1pdGVtIHNldHRpbmdzLXNlYXJjaC1pbnB1dFwiKTtcclxuICAgIHNldHRpbmdzUmVzdWx0c0VsOiBIVE1MRGl2RWxlbWVudDtcclxuICAgIHNlYXJjaDogU2VhcmNoQ29tcG9uZW50O1xyXG4gICAgbG9jYWxlOiBzdHJpbmc7XHJcblxyXG4gICAgcmVzb3VyY2VzOiBSZXNvdXJjZVtdID0gW107XHJcbiAgICByZXN1bHRzOiBSZXNvdXJjZVtdID0gW107XHJcblxyXG4gICAgYXN5bmMgb25sb2FkKCkge1xyXG4gICAgICAgIHRoaXMuYXBwLndvcmtzcGFjZS5vbkxheW91dFJlYWR5KGFzeW5jICgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1Jlc3VsdHNDb250YWluZXJFbC5jcmVhdGVFbChcImgzXCIsIHtcclxuICAgICAgICAgICAgICAgIHRleHQ6IFwiU2V0dGluZ3MgU2VhcmNoIFJlc3VsdHNcIlxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1Jlc3VsdHNFbCA9IHRoaXMuc2V0dGluZ3NSZXN1bHRzQ29udGFpbmVyRWwuY3JlYXRlRGl2KFxyXG4gICAgICAgICAgICAgICAgXCJzZXR0aW5ncy1zZWFyY2gtcmVzdWx0c1wiXHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLmJ1aWxkU2NvcGUoKTtcclxuICAgICAgICAgICAgdGhpcy5idWlsZFNlYXJjaCgpO1xyXG4gICAgICAgICAgICB0aGlzLmJ1aWxkUmVzb3VyY2VzKCk7XHJcbiAgICAgICAgICAgIHRoaXMuYnVpbGRQbHVnaW5SZXNvdXJjZXMoKTtcclxuICAgICAgICAgICAgdGhpcy5wYXRjaFNldHRpbmdzKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICB0YWJJbmRleCA9IDA7XHJcbiAgICBwbHVnaW5UYWJJbmRleCA9IDA7XHJcbiAgICBidWlsZFJlc291cmNlcygpIHtcclxuICAgICAgICBjb25zdCB0YWIgPSB0aGlzLmFwcC5zZXR0aW5nLnNldHRpbmdUYWJzW3RoaXMudGFiSW5kZXhdO1xyXG4gICAgICAgIGlmICh0YWIpIHtcclxuICAgICAgICAgICAgdGhpcy5nZXRUYWJSZXNvdXJjZXModGFiKTtcclxuICAgICAgICAgICAgdGhpcy50YWJJbmRleCsrO1xyXG4gICAgICAgICAgICBzZXRJbW1lZGlhdGUoKCkgPT4gdGhpcy5idWlsZFJlc291cmNlcygpKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBidWlsZFBsdWdpblJlc291cmNlcygpIHtcclxuICAgICAgICBjb25zdCB0YWIgPSB0aGlzLmFwcC5zZXR0aW5nLnBsdWdpblRhYnNbdGhpcy5wbHVnaW5UYWJJbmRleF07XHJcbiAgICAgICAgaWYgKHRhYikge1xyXG4gICAgICAgICAgICB0aGlzLmdldFRhYlJlc291cmNlcyh0YWIpO1xyXG4gICAgICAgICAgICB0aGlzLnBsdWdpblRhYkluZGV4Kys7XHJcbiAgICAgICAgICAgIHNldEltbWVkaWF0ZSgoKSA9PiB0aGlzLmJ1aWxkUGx1Z2luUmVzb3VyY2VzKCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGdldCBtYW5pZmVzdHMoKSB7XHJcbiAgICAgICAgcmV0dXJuIE9iamVjdC52YWx1ZXModGhpcy5hcHAucGx1Z2lucy5tYW5pZmVzdHMpO1xyXG4gICAgfVxyXG4gICAgc2V0dGluZ0NhY2hlOiBNYXA8c3RyaW5nLCBTZXR0aW5nPiA9IG5ldyBNYXAoKTtcclxuICAgIGFkZFJlc291cmNlVG9DYWNoZShyZXNvdXJjZTogUmVzb3VyY2UpIHtcclxuICAgICAgICBjb25zdCBzZXR0aW5nID0gbmV3IFNldHRpbmcoY3JlYXRlRGl2KCkpXHJcbiAgICAgICAgICAgIC5zZXROYW1lKHJlc291cmNlLnRleHQpXHJcbiAgICAgICAgICAgIC5zZXREZXNjKFxyXG4gICAgICAgICAgICAgICAgY3JlYXRlRnJhZ21lbnQoXHJcbiAgICAgICAgICAgICAgICAgICAgKGUpID0+IChlLmNyZWF0ZURpdigpLmlubmVySFRNTCA9IHJlc291cmNlLmRlc2MgPz8gXCJcIilcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKHJlc291cmNlLnRhYiA9PSBcImNvbW11bml0eS1wbHVnaW5zXCIpIHtcclxuICAgICAgICAgICAgbGV0IHBsdWdpbiA9IHRoaXMubWFuaWZlc3RzLmZpbmQoKHApID0+IHAubmFtZSA9PSByZXNvdXJjZS50ZXh0KTtcclxuICAgICAgICAgICAgaWYgKFxyXG4gICAgICAgICAgICAgICAgcGx1Z2luICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcC5wbHVnaW5zLmdldFBsdWdpbihwbHVnaW4uaWQpPy5fbG9hZGVkICYmXHJcbiAgICAgICAgICAgICAgICB0aGlzLmFwcC5zZXR0aW5nLnBsdWdpblRhYnMuZmluZCgodCkgPT4gdC5pZCA9PSBwbHVnaW4uaWQpXHJcbiAgICAgICAgICAgICkge1xyXG4gICAgICAgICAgICAgICAgc2V0dGluZy5hZGRFeHRyYUJ1dHRvbigoYikgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGIuc2V0VG9vbHRpcChgT3BlbiAke3Jlc291cmNlLnRleHR9IFNldHRpbmdzYCkub25DbGljayhcclxuICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcHAuc2V0dGluZy5vcGVuVGFiQnlJZChwbHVnaW4uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChyZXNvdXJjZS50YWIgPT0gXCJwbHVnaW5zXCIpIHtcclxuICAgICAgICAgICAgY29uc3QgcGx1Z2lucyA9IE9iamVjdC52YWx1ZXModGhpcy5hcHAuaW50ZXJuYWxQbHVnaW5zLnBsdWdpbnMpO1xyXG4gICAgICAgICAgICBjb25zdCBwbHVnaW4gPSBwbHVnaW5zLmZpbmQoXHJcbiAgICAgICAgICAgICAgICAocCkgPT4gcC5fbG9hZGVkICYmIHAuaW5zdGFuY2UubmFtZSA9PSByZXNvdXJjZS50ZXh0XHJcbiAgICAgICAgICAgICk7XHJcblxyXG4gICAgICAgICAgICBpZiAoXHJcbiAgICAgICAgICAgICAgICBwbHVnaW4gJiZcclxuICAgICAgICAgICAgICAgIHRoaXMuYXBwLnNldHRpbmcucGx1Z2luVGFicy5maW5kKFxyXG4gICAgICAgICAgICAgICAgICAgICh0KSA9PiB0LmlkID09IHBsdWdpbi5pbnN0YW5jZS5pZFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgIHNldHRpbmcuYWRkRXh0cmFCdXR0b24oKGIpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBiLnNldFRvb2x0aXAoYE9wZW4gJHtyZXNvdXJjZS50ZXh0fSBTZXR0aW5nc2ApLm9uQ2xpY2soXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLnNldHRpbmcub3BlblRhYkJ5SWQocGx1Z2luLmluc3RhbmNlLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBzZXR0aW5nLmFkZEV4dHJhQnV0dG9uKChiKSA9PiB7XHJcbiAgICAgICAgICAgIGIuc2V0SWNvbihcImZvcndhcmQtYXJyb3dcIikub25DbGljaygoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dSZXN1bHQocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLnNldHRpbmdDYWNoZS5zZXQocmVzb3VyY2UudGV4dCwgc2V0dGluZyk7XHJcbiAgICB9XHJcbiAgICBnZXRSZXNvdXJjZUZyb21DYWNoZShyZXNvdXJjZTogUmVzb3VyY2UpIHtcclxuICAgICAgICBpZiAoIXRoaXMuc2V0dGluZ0NhY2hlLmhhcyhyZXNvdXJjZS50ZXh0KSkge1xyXG4gICAgICAgICAgICB0aGlzLmFkZFJlc291cmNlVG9DYWNoZShyZXNvdXJjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLnNldHRpbmdDYWNoZS5nZXQocmVzb3VyY2UudGV4dCk7XHJcbiAgICB9XHJcbiAgICByZW1vdmVSZXNvdXJjZXNGcm9tQ2FjaGUocmVzb3VyY2VzOiBSZXNvdXJjZVtdKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCByZXNvdXJjZSBvZiByZXNvdXJjZXMpIHtcclxuICAgICAgICAgICAgdGhpcy5zZXR0aW5nQ2FjaGUuZGVsZXRlKHJlc291cmNlLnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIGFzeW5jIGdldFRhYlJlc291cmNlcyh0YWI6IFNldHRpbmdUYWIpIHtcclxuICAgICAgICBhd2FpdCB0YWIuZGlzcGxheSgpO1xyXG5cclxuICAgICAgICBjb25zdCBzZXR0aW5ncyA9IHRhYi5jb250YWluZXJFbC5xdWVyeVNlbGVjdG9yQWxsPEhUTUxEaXZFbGVtZW50PihcclxuICAgICAgICAgICAgXCIuc2V0dGluZy1pdGVtOm5vdCguc2V0dGluZy1pdGVtLWhlYWRlcilcIlxyXG4gICAgICAgICk7XHJcbiAgICAgICAgZm9yIChjb25zdCBlbCBvZiBBcnJheS5mcm9tKHNldHRpbmdzKSkge1xyXG4gICAgICAgICAgICBjb25zdCB0ZXh0ID1cclxuICAgICAgICAgICAgICAgIGVsLnF1ZXJ5U2VsZWN0b3I8SFRNTERpdkVsZW1lbnQ+KFxyXG4gICAgICAgICAgICAgICAgICAgIFwiLnNldHRpbmctaXRlbS1uYW1lXCJcclxuICAgICAgICAgICAgICAgICk/LnRleHRDb250ZW50O1xyXG4gICAgICAgICAgICBpZiAoIXRleHQpIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgZGVzYyA9XHJcbiAgICAgICAgICAgICAgICBlbC5xdWVyeVNlbGVjdG9yPEhUTUxEaXZFbGVtZW50PihcIi5zZXR0aW5nLWl0ZW0tZGVzY3JpcHRpb25cIilcclxuICAgICAgICAgICAgICAgICAgICA/LmlubmVySFRNTCA/PyBcIlwiO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgcmVzb3VyY2UgPSB7XHJcbiAgICAgICAgICAgICAgICB0YWI6IHRhYi5pZCxcclxuICAgICAgICAgICAgICAgIG5hbWU6IHRhYi5uYW1lLFxyXG4gICAgICAgICAgICAgICAgdGV4dCxcclxuICAgICAgICAgICAgICAgIGRlc2NcclxuICAgICAgICAgICAgfTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucmVzb3VyY2VzLnB1c2gocmVzb3VyY2UpO1xyXG4gICAgICAgICAgICB0aGlzLmFkZFJlc291cmNlVG9DYWNoZShyZXNvdXJjZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLmFwcC5zZXR0aW5nLmFjdGl2ZVRhYj8uaWQgPT0gdGFiLmlkKSByZXR1cm47XHJcbiAgICAgICAgdGFiLmNvbnRhaW5lckVsLmRldGFjaCgpO1xyXG4gICAgICAgIHRhYi5oaWRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcGF0Y2hTZXR0aW5ncygpIHtcclxuICAgICAgICBjb25zdCBzZWxmID0gdGhpcztcclxuXHJcbiAgICAgICAgdGhpcy5yZWdpc3RlcihcclxuICAgICAgICAgICAgYXJvdW5kKHRoaXMuYXBwLnNldHRpbmcsIHtcclxuICAgICAgICAgICAgICAgIG9uT3BlbjogZnVuY3Rpb24gKG5leHQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBuZXh0LmFwcGx5KHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNlYXJjaC5pbnB1dEVsLmZvY3VzKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0O1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy9QYXRjaCBhZGRTZXR0aW5nVGFiIHRvIGNhcHR1cmUgY2hhbmdlcyB0byBwbHVnaW4gc2V0dGluZ3MuXHJcbiAgICAgICAgdGhpcy5yZWdpc3RlcihcclxuICAgICAgICAgICAgYXJvdW5kKHRoaXMuYXBwLnNldHRpbmcsIHtcclxuICAgICAgICAgICAgICAgIGFkZFNldHRpbmdUYWI6IGZ1bmN0aW9uIChuZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0YWI6IFNldHRpbmdUYWIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5nZXRUYWJSZXNvdXJjZXModGFiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5leHQuY2FsbCh0aGlzLCB0YWIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgLy9QYXRjaCByZW1vdmVTZXR0aW5nVGFiIHRvIGNhcHR1cmUgY2hhbmdlcyB0byBwbHVnaW4gc2V0dGluZ3MuXHJcbiAgICAgICAgdGhpcy5yZWdpc3RlcihcclxuICAgICAgICAgICAgYXJvdW5kKHRoaXMuYXBwLnNldHRpbmcsIHtcclxuICAgICAgICAgICAgICAgIHJlbW92ZVNldHRpbmdUYWI6IGZ1bmN0aW9uIChuZXh0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uICh0YWI6IFNldHRpbmdUYWIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNQbHVnaW5TZXR0aW5nVGFiKHRhYikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW92aW5nID0gc2VsZi5yZXNvdXJjZXMuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICh0KSA9PiB0LnRhYiA9PSB0YWIuaWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlc291cmNlcyA9IHNlbGYucmVzb3VyY2VzLmZpbHRlcihcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAodCkgPT4gdC50YWIgIT0gdGFiLmlkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1vdmVSZXNvdXJjZXNGcm9tQ2FjaGUocmVtb3ZpbmcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXh0LmNhbGwodGhpcywgdGFiKTtcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHRoaXMucmVnaXN0ZXIoXHJcbiAgICAgICAgICAgIGFyb3VuZCh0aGlzLmFwcC5zZXR0aW5nLCB7XHJcbiAgICAgICAgICAgICAgICBvcGVuVGFiOiBmdW5jdGlvbiAobmV4dCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiAodGFiOiBTZXR0aW5nVGFiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2VhcmNoQXBwZW5kZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hcHAua2V5bWFwLnBvcFNjb3BlKHNlbGYuc2NvcGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlx1RDgzRFx1REU4MCB+IGZpbGU6IG1haW4udHMgfiBsaW5lIDI3MCB+IHBvcFNjb3BlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5jYWxsKHRoaXMsIHRhYik7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBvcGVuVGFiQnlJZDogZnVuY3Rpb24gKG5leHQpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKHRhYjogc3RyaW5nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2VhcmNoQXBwZW5kZWQgPSBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5hcHAua2V5bWFwLnBvcFNjb3BlKHNlbGYuc2NvcGUpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIlx1RDgzRFx1REU4MCB+IGZpbGU6IG1haW4udHMgfiBsaW5lIDI3NyB+IHBvcFNjb3BlXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV4dC5jYWxsKHRoaXMsIHRhYik7XHJcbiAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGJ1aWxkU2VhcmNoKCkge1xyXG4gICAgICAgIGNvbnN0IHRlbXBTZXR0aW5nID0gbmV3IFNldHRpbmcoY3JlYXRlRGl2KCkpLmFkZFNlYXJjaCgocykgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnNlYXJjaCA9IHM7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0dGluZ3NOYXZJdGVtQ29udGFpbmVyLmFwcGVuZCh0ZW1wU2V0dGluZy5jb250cm9sRWwpO1xyXG5cclxuICAgICAgICB0ZW1wU2V0dGluZy5zZXR0aW5nRWwuZGV0YWNoKCk7XHJcblxyXG4gICAgICAgIHRoaXMuc2VhcmNoLm9uQ2hhbmdlKCh2KSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2Uodik7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zZWFyY2guc2V0UGxhY2Vob2xkZXIoXCJTZWFyY2ggc2V0dGluZ3MuLi5cIik7XHJcbiAgICAgICAgdGhpcy5hcHAuc2V0dGluZy50YWJIZWFkZXJzRWwucHJlcGVuZCh0aGlzLnNldHRpbmdzU2VhcmNoRWwpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlYXJjaEFwcGVuZGVkID0gZmFsc2U7XHJcbiAgICBhY3RpdmVJbmRleCA9IC0xO1xyXG4gICAgYWN0aXZlU2V0dGluZzogU2V0dGluZztcclxuICAgIHNjb3BlID0gbmV3IFNjb3BlKHRoaXMuYXBwLnNjb3BlKTtcclxuICAgIGJ1aWxkU2NvcGUoKSB7XHJcbiAgICAgICAgdGhpcy5zY29wZS5yZWdpc3RlcihbXSwgXCJBcnJvd0Rvd25cIiwgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImFycm93ZG93blwiKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlU2V0dGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTZXR0aW5nLnNldHRpbmdFbC5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUluZGV4ID1cclxuICAgICAgICAgICAgICAgICgoKHRoaXMuYWN0aXZlSW5kZXggKyAxKSAlIHRoaXMucmVzdWx0cy5sZW5ndGgpICtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHMubGVuZ3RoKSAlXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHMubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jZW50ZXJBY3RpdmVTZXR0aW5nKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zY29wZS5yZWdpc3RlcihbXSwgXCJBcnJvd1VwXCIsICgpID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJhcnJvdyB1cFwiKTtcclxuICAgICAgICAgICAgaWYgKHRoaXMuYWN0aXZlU2V0dGluZykge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5hY3RpdmVTZXR0aW5nLnNldHRpbmdFbC5yZW1vdmVDbGFzcyhcImFjdGl2ZVwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB0aGlzLmFjdGl2ZUluZGV4ID1cclxuICAgICAgICAgICAgICAgICgoKHRoaXMuYWN0aXZlSW5kZXggLSAxKSAlIHRoaXMucmVzdWx0cy5sZW5ndGgpICtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHMubGVuZ3RoKSAlXHJcbiAgICAgICAgICAgICAgICB0aGlzLnJlc3VsdHMubGVuZ3RoO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5jZW50ZXJBY3RpdmVTZXR0aW5nKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5zY29wZS5yZWdpc3RlcihbXSwgXCJFbnRlclwiLCAoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiZW50ZXJcIik7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmFjdGl2ZVNldHRpbmcpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1Jlc3VsdCh0aGlzLnJlc3VsdHNbdGhpcy5hY3RpdmVJbmRleF0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2VudGVyQWN0aXZlU2V0dGluZygpIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSB0aGlzLnJlc3VsdHNbdGhpcy5hY3RpdmVJbmRleF07XHJcbiAgICAgICAgdGhpcy5hY3RpdmVTZXR0aW5nID0gdGhpcy5nZXRSZXNvdXJjZUZyb21DYWNoZShyZXN1bHQpO1xyXG4gICAgICAgIHRoaXMuYWN0aXZlU2V0dGluZy5zZXR0aW5nRWwuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XHJcblxyXG4gICAgICAgIHRoaXMuYWN0aXZlU2V0dGluZy5zZXR0aW5nRWwuc2Nyb2xsSW50b1ZpZXcoe1xyXG4gICAgICAgICAgICBiZWhhdmlvcjogXCJhdXRvXCIsXHJcbiAgICAgICAgICAgIGJsb2NrOiBcIm5lYXJlc3RcIlxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIG9uQ2hhbmdlKHY6IHN0cmluZykge1xyXG4gICAgICAgIGlmICghdikge1xyXG4gICAgICAgICAgICB0aGlzLmFwcC5zZXR0aW5nLm9wZW5UYWJCeUlkKHRoaXMuYXBwLnNldHRpbmcubGFzdFRhYklkKTtcclxuICAgICAgICAgICAgdGhpcy5zZWFyY2hBcHBlbmRlZCA9IGZhbHNlO1xyXG4gICAgICAgICAgICB0aGlzLmFwcC5rZXltYXAucG9wU2NvcGUodGhpcy5zY29wZSk7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiXHVEODNEXHVERTgwIH4gZmlsZTogbWFpbi50cyB+IGxpbmUgMzU1IH4gcG9wU2NvcGVcIik7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZlSW5kZXggPSAtMTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIXRoaXMuc2VhcmNoQXBwZW5kZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5hcHAuc2V0dGluZy5hY3RpdmVUYWIubmF2RWwucmVtb3ZlQ2xhc3MoXCJpcy1hY3RpdmVcIik7XHJcbiAgICAgICAgICAgIHRoaXMuYXBwLnNldHRpbmcudGFiQ29udGVudENvbnRhaW5lci5lbXB0eSgpO1xyXG4gICAgICAgICAgICB0aGlzLmFwcC5zZXR0aW5nLnRhYkNvbnRlbnRDb250YWluZXIuYXBwZW5kKFxyXG4gICAgICAgICAgICAgICAgdGhpcy5zZXR0aW5nc1Jlc3VsdHNDb250YWluZXJFbFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB0aGlzLnNlYXJjaEFwcGVuZGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgdGhpcy5hcHAua2V5bWFwLnBvcFNjb3BlKHRoaXMuc2NvcGUpO1xyXG4gICAgICAgICAgICB0aGlzLmFwcC5rZXltYXAucHVzaFNjb3BlKHRoaXMuc2NvcGUpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlx1RDgzRFx1REU4MCB+IGZpbGU6IG1haW4udHMgfiBsaW5lIDM2OCB+IHB1c2hTY29wZVwiKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5hcHBlbmRSZXN1bHRzKHRoaXMucGVyZm9ybUZ1enp5U2VhcmNoKHYpKTtcclxuICAgIH1cclxuICAgIGdldE1hdGNoVGV4dCh0ZXh0OiBzdHJpbmcsIHJlc3VsdDogU2VhcmNoUmVzdWx0KSB7XHJcbiAgICAgICAgY29uc3QgbWF0Y2hFbGVtZW50czogUmVjb3JkPG51bWJlciwgSFRNTEVsZW1lbnQ+ID0ge307XHJcbiAgICAgICAgcmV0dXJuIGNyZWF0ZUZyYWdtZW50KChjb250ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICAgICAgbGV0IG1hdGNoID0gcmVzdWx0Lm1hdGNoZXMuZmluZCgobSkgPT4gbVswXSA9PT0gaSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobWF0Y2gpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBpbmRleCA9IHJlc3VsdC5tYXRjaGVzLmluZGV4T2YobWF0Y2gpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghbWF0Y2hFbGVtZW50c1tpbmRleF0pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hFbGVtZW50c1tpbmRleF0gPSBjcmVhdGVTcGFuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJzdWdnZXN0aW9uLWhpZ2hsaWdodFwiXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGxldCBlbGVtZW50ID0gbWF0Y2hFbGVtZW50c1tpbmRleF07XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudC5hcHBlbmRDaGlsZChlbGVtZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZFRleHQodGV4dC5zdWJzdHJpbmcobWF0Y2hbMF0sIG1hdGNoWzFdKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgICAgIGkgKz0gbWF0Y2hbMV0gLSBtYXRjaFswXSAtIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29udGVudC5hcHBlbmRUZXh0KHRleHRbaV0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBhcHBlbmRSZXN1bHRzKHJlc3VsdHM6IFJlc291cmNlW10pIHtcclxuICAgICAgICB0aGlzLnNldHRpbmdzUmVzdWx0c0VsLmVtcHR5KCk7XHJcbiAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIEhUTUxFbGVtZW50PiA9IHt9O1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHJlc291cmNlIG9mIHJlc3VsdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmICghKHJlc291cmNlLnRhYiBpbiBoZWFkZXJzKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIC8qIGlmIChyZXNvdXJjZS50YWIgPT0gXCJob3RrZXlzXCIpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVyc1tyZXNvdXJjZS50YWJdID0gY3JlYXRlRGl2KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsgKi9cclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzW3Jlc291cmNlLnRhYl0gPSB0aGlzLnNldHRpbmdzUmVzdWx0c0VsLmNyZWF0ZURpdigpO1xyXG4gICAgICAgICAgICAgICAgICAgIC8qIH0gKi9cclxuICAgICAgICAgICAgICAgICAgICBuZXcgU2V0dGluZyhoZWFkZXJzW3Jlc291cmNlLnRhYl0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRIZWFkaW5nKClcclxuICAgICAgICAgICAgICAgICAgICAgICAgLnNldE5hbWUocmVzb3VyY2UubmFtZSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgY29uc3Qgc2V0dGluZyA9IHRoaXMuZ2V0UmVzb3VyY2VGcm9tQ2FjaGUocmVzb3VyY2UpO1xyXG5cclxuICAgICAgICAgICAgICAgIGhlYWRlcnNbcmVzb3VyY2UudGFiXS5hcHBlbmQoc2V0dGluZy5zZXR0aW5nRWwpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIC8qIGlmIChcImhvdGtleXNcIiBpbiBoZWFkZXJzKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNldHRpbmdzUmVzdWx0c0VsLmFwcGVuZENoaWxkKGhlYWRlcnNbXCJob3RrZXlzXCJdKTtcclxuICAgICAgICAgICAgfSAqL1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0dGluZ3NSZXN1bHRzRWwuc2V0VGV4dChcIk5vIHJlc3VsdHMgZm91bmQgOihcIik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHNob3dSZXN1bHQocmVzdWx0OiBSZXNvdXJjZSkge1xyXG4gICAgICAgIHRoaXMuc2VhcmNoLnNldFZhbHVlKFwiXCIpO1xyXG4gICAgICAgIGNvbnN0IHRhYiA9XHJcbiAgICAgICAgICAgIHRoaXMuYXBwLnNldHRpbmcuc2V0dGluZ1RhYnMuZmluZCgodCkgPT4gdC5pZCA9PSByZXN1bHQudGFiKSA/P1xyXG4gICAgICAgICAgICB0aGlzLmFwcC5zZXR0aW5nLnBsdWdpblRhYnMuZmluZCgodCkgPT4gdC5pZCA9PSByZXN1bHQudGFiKTtcclxuICAgICAgICBpZiAoIXRhYikge1xyXG4gICAgICAgICAgICBuZXcgTm90aWNlKFwiVGhlcmUgd2FzIGFuIGlzc3VlIG9wZW5pbmcgdGhlIHNldHRpbmcgdGFiLlwiKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5hcHAuc2V0dGluZy5vcGVuVGFiQnlJZCh0YWIuaWQpO1xyXG4gICAgICAgIHRoaXMuYXBwLmtleW1hcC5wb3BTY29wZSh0aGlzLnNjb3BlKTtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIlx1RDgzRFx1REU4MCB+IGZpbGU6IG1haW4udHMgfiBsaW5lIDQzNSB+IHBvcFNjb3BlXCIpO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICBjb25zdCBuYW1lcyA9XHJcbiAgICAgICAgICAgICAgICB0YWIuY29udGFpbmVyRWwucXVlcnlTZWxlY3RvckFsbChcIi5zZXR0aW5nLWl0ZW0tbmFtZVwiKTtcclxuICAgICAgICAgICAgY29uc3QgZWwgPSBBcnJheS5mcm9tKG5hbWVzKS5maW5kKFxyXG4gICAgICAgICAgICAgICAgKG4pID0+IG4udGV4dENvbnRlbnQgPT0gcmVzdWx0LnRleHRcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgaWYgKCFlbCkgcmV0dXJuO1xyXG5cclxuICAgICAgICAgICAgY29uc3Qgc2V0dGluZyA9IGVsLmNsb3Nlc3QoXCIuc2V0dGluZy1pdGVtXCIpO1xyXG4gICAgICAgICAgICBpZiAoIXNldHRpbmcpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIGlmICh0YWIuaWQgPT0gXCJvYnNpZGlhbi1zdHlsZS1zZXR0aW5nc1wiKSB7XHJcbiAgICAgICAgICAgICAgICBsZXQgY29sbGFwc2VkID0gc2V0dGluZy5jbG9zZXN0KFwiLnN0eWxlLXNldHRpbmdzLWNvbnRhaW5lclwiKTtcclxuICAgICAgICAgICAgICAgIGxldCBwcmV2aW91cyA9IGNvbGxhcHNlZD8ucHJldmlvdXNFbGVtZW50U2libGluZztcclxuXHJcbiAgICAgICAgICAgICAgICB3aGlsZSAoXHJcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMgIT0gbnVsbCAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzLmhhc0NsYXNzKFwiaXMtY29sbGFwc2VkXCIpICYmXHJcbiAgICAgICAgICAgICAgICAgICAgcHJldmlvdXMuaGFzQ2xhc3MoXCJzdHlsZS1zZXR0aW5ncy1oZWFkaW5nXCIpXHJcbiAgICAgICAgICAgICAgICApIHtcclxuICAgICAgICAgICAgICAgICAgICBwcmV2aW91cy5yZW1vdmVDbGFzcyhcImlzLWNvbGxhcHNlZFwiKTtcclxuICAgICAgICAgICAgICAgICAgICBjb2xsYXBzZWQgPSBjb2xsYXBzZWQucGFyZW50RWxlbWVudD8uY2xvc2VzdChcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCIuc3R5bGUtc2V0dGluZ3MtY29udGFpbmVyXCJcclxuICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIHByZXZpb3VzID0gY29sbGFwc2VkPy5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBsZXQgZGV0YWlscyA9IHNldHRpbmcuY2xvc2VzdChcImRldGFpbHNcIik7XHJcbiAgICAgICAgICAgIHdoaWxlIChkZXRhaWxzKSB7XHJcbiAgICAgICAgICAgICAgICBkZXRhaWxzLnNldEF0dHIoXCJvcGVuXCIsIFwib3BlblwiKTtcclxuICAgICAgICAgICAgICAgIGRldGFpbHMgPSBkZXRhaWxzLnBhcmVudEVsZW1lbnQ/LmNsb3Nlc3QoXCJkZXRhaWxzXCIpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBzZXR0aW5nLnNjcm9sbEludG9WaWV3KHRydWUpO1xyXG5cclxuICAgICAgICAgICAgc2V0dGluZy5hZGRDbGFzcyhcImlzLWZsYXNoaW5nXCIpO1xyXG4gICAgICAgICAgICB0aGlzLnJlZ2lzdGVySW50ZXJ2YWwoXHJcbiAgICAgICAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dChcclxuICAgICAgICAgICAgICAgICAgICAoKSA9PiBzZXR0aW5nLnJlbW92ZUNsYXNzKFwiaXMtZmxhc2hpbmdcIiksXHJcbiAgICAgICAgICAgICAgICAgICAgMzAwMFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcGVyZm9ybUZ1enp5U2VhcmNoKGlucHV0OiBzdHJpbmcpIHtcclxuICAgICAgICBjb25zdCByZXN1bHRzOiBSZXNvdXJjZVtdID0gW10sXHJcbiAgICAgICAgICAgIGhvdGtleXM6IFJlc291cmNlW10gPSBbXTtcclxuICAgICAgICBmb3IgKGNvbnN0IHJlc291cmNlIG9mIHRoaXMucmVzb3VyY2VzKSB7XHJcbiAgICAgICAgICAgIGxldCByZXN1bHQgPVxyXG4gICAgICAgICAgICAgICAgcHJlcGFyZVNpbXBsZVNlYXJjaChpbnB1dCkocmVzb3VyY2UudGV4dCkgPz9cclxuICAgICAgICAgICAgICAgIHByZXBhcmVTaW1wbGVTZWFyY2goaW5wdXQpKHJlc291cmNlLmRlc2MpO1xyXG4gICAgICAgICAgICBpZiAocmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICBpZiAocmVzb3VyY2UudGFiID09IFwiaG90a2V5c1wiKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaG90a2V5cy5wdXNoKHJlc291cmNlKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHJlc291cmNlKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLnJlc3VsdHMgPSBbLi4ucmVzdWx0cywgLi4uaG90a2V5c107XHJcbiAgICAgICAgcmV0dXJuIHRoaXMucmVzdWx0cztcclxuICAgIH1cclxuXHJcbiAgICBvbnVubG9hZCgpIHtcclxuICAgICAgICB0aGlzLnNldHRpbmdzU2VhcmNoRWwuZGV0YWNoKCk7XHJcbiAgICAgICAgdGhpcy5zZXR0aW5nc1Jlc3VsdHNFbC5kZXRhY2goKTtcclxuICAgICAgICBpZiAodGhpcy5zZWFyY2hBcHBlbmRlZClcclxuICAgICAgICAgICAgdGhpcy5hcHAuc2V0dGluZy5vcGVuVGFiQnlJZCh0aGlzLmFwcC5zZXR0aW5nLmxhc3RUYWJJZCk7XHJcbiAgICB9XHJcbn1cclxuIiwgImV4cG9ydCBmdW5jdGlvbiBhcm91bmQob2JqLCBmYWN0b3JpZXMpIHtcbiAgICBjb25zdCByZW1vdmVycyA9IE9iamVjdC5rZXlzKGZhY3RvcmllcykubWFwKGtleSA9PiBhcm91bmQxKG9iaiwga2V5LCBmYWN0b3JpZXNba2V5XSkpO1xuICAgIHJldHVybiByZW1vdmVycy5sZW5ndGggPT09IDEgPyByZW1vdmVyc1swXSA6IGZ1bmN0aW9uICgpIHsgcmVtb3ZlcnMuZm9yRWFjaChyID0+IHIoKSk7IH07XG59XG5mdW5jdGlvbiBhcm91bmQxKG9iaiwgbWV0aG9kLCBjcmVhdGVXcmFwcGVyKSB7XG4gICAgY29uc3Qgb3JpZ2luYWwgPSBvYmpbbWV0aG9kXSwgaGFkT3duID0gb2JqLmhhc093blByb3BlcnR5KG1ldGhvZCk7XG4gICAgbGV0IGN1cnJlbnQgPSBjcmVhdGVXcmFwcGVyKG9yaWdpbmFsKTtcbiAgICAvLyBMZXQgb3VyIHdyYXBwZXIgaW5oZXJpdCBzdGF0aWMgcHJvcHMgZnJvbSB0aGUgd3JhcHBpbmcgbWV0aG9kLFxuICAgIC8vIGFuZCB0aGUgd3JhcHBpbmcgbWV0aG9kLCBwcm9wcyBmcm9tIHRoZSBvcmlnaW5hbCBtZXRob2RcbiAgICBpZiAob3JpZ2luYWwpXG4gICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihjdXJyZW50LCBvcmlnaW5hbCk7XG4gICAgT2JqZWN0LnNldFByb3RvdHlwZU9mKHdyYXBwZXIsIGN1cnJlbnQpO1xuICAgIG9ialttZXRob2RdID0gd3JhcHBlcjtcbiAgICAvLyBSZXR1cm4gYSBjYWxsYmFjayB0byBhbGxvdyBzYWZlIHJlbW92YWxcbiAgICByZXR1cm4gcmVtb3ZlO1xuICAgIGZ1bmN0aW9uIHdyYXBwZXIoLi4uYXJncykge1xuICAgICAgICAvLyBJZiB3ZSBoYXZlIGJlZW4gZGVhY3RpdmF0ZWQgYW5kIGFyZSBubyBsb25nZXIgd3JhcHBlZCwgcmVtb3ZlIG91cnNlbHZlc1xuICAgICAgICBpZiAoY3VycmVudCA9PT0gb3JpZ2luYWwgJiYgb2JqW21ldGhvZF0gPT09IHdyYXBwZXIpXG4gICAgICAgICAgICByZW1vdmUoKTtcbiAgICAgICAgcmV0dXJuIGN1cnJlbnQuYXBwbHkodGhpcywgYXJncyk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHJlbW92ZSgpIHtcbiAgICAgICAgLy8gSWYgbm8gb3RoZXIgcGF0Y2hlcywganVzdCBkbyBhIGRpcmVjdCByZW1vdmFsXG4gICAgICAgIGlmIChvYmpbbWV0aG9kXSA9PT0gd3JhcHBlcikge1xuICAgICAgICAgICAgaWYgKGhhZE93bilcbiAgICAgICAgICAgICAgICBvYmpbbWV0aG9kXSA9IG9yaWdpbmFsO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIGRlbGV0ZSBvYmpbbWV0aG9kXTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoY3VycmVudCA9PT0gb3JpZ2luYWwpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIC8vIEVsc2UgcGFzcyBmdXR1cmUgY2FsbHMgdGhyb3VnaCwgYW5kIHJlbW92ZSB3cmFwcGVyIGZyb20gdGhlIHByb3RvdHlwZSBjaGFpblxuICAgICAgICBjdXJyZW50ID0gb3JpZ2luYWw7XG4gICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZih3cmFwcGVyLCBvcmlnaW5hbCB8fCBGdW5jdGlvbik7XG4gICAgfVxufVxuZXhwb3J0IGZ1bmN0aW9uIGRlZHVwZShrZXksIG9sZEZuLCBuZXdGbikge1xuICAgIGNoZWNrW2tleV0gPSBrZXk7XG4gICAgcmV0dXJuIGNoZWNrO1xuICAgIGZ1bmN0aW9uIGNoZWNrKC4uLmFyZ3MpIHtcbiAgICAgICAgcmV0dXJuIChvbGRGbltrZXldID09PSBrZXkgPyBvbGRGbiA6IG5ld0ZuKS5hcHBseSh0aGlzLCBhcmdzKTtcbiAgICB9XG59XG5leHBvcnQgZnVuY3Rpb24gYWZ0ZXIocHJvbWlzZSwgY2IpIHtcbiAgICByZXR1cm4gcHJvbWlzZS50aGVuKGNiLCBjYik7XG59XG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplKGFzeW5jRnVuY3Rpb24pIHtcbiAgICBsZXQgbGFzdFJ1biA9IFByb21pc2UucmVzb2x2ZSgpO1xuICAgIGZ1bmN0aW9uIHdyYXBwZXIoLi4uYXJncykge1xuICAgICAgICByZXR1cm4gbGFzdFJ1biA9IG5ldyBQcm9taXNlKChyZXMsIHJlaikgPT4ge1xuICAgICAgICAgICAgYWZ0ZXIobGFzdFJ1biwgKCkgPT4ge1xuICAgICAgICAgICAgICAgIGFzeW5jRnVuY3Rpb24uYXBwbHkodGhpcywgYXJncykudGhlbihyZXMsIHJlaik7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHdyYXBwZXIuYWZ0ZXIgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBsYXN0UnVuID0gbmV3IFByb21pc2UoKHJlcywgcmVqKSA9PiB7IGFmdGVyKGxhc3RSdW4sIHJlcyk7IH0pO1xuICAgIH07XG4gICAgcmV0dXJuIHdyYXBwZXI7XG59XG4iXSwKICAibWFwcGluZ3MiOiAiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBO0FBQUE7QUFBQTtBQUFBLHNCQVNPOzs7QUNUQSxnQkFBZ0IsS0FBSyxXQUFXO0FBQ25DLFFBQU0sV0FBVyxPQUFPLEtBQUssV0FBVyxJQUFJLFNBQU8sUUFBUSxLQUFLLEtBQUssVUFBVTtBQUMvRSxTQUFPLFNBQVMsV0FBVyxJQUFJLFNBQVMsS0FBSyxXQUFZO0FBQUUsYUFBUyxRQUFRLE9BQUs7QUFBQTtBQUFBO0FBRXJGLGlCQUFpQixLQUFLLFFBQVEsZUFBZTtBQUN6QyxRQUFNLFdBQVcsSUFBSSxTQUFTLFNBQVMsSUFBSSxlQUFlO0FBQzFELE1BQUksVUFBVSxjQUFjO0FBRzVCLE1BQUk7QUFDQSxXQUFPLGVBQWUsU0FBUztBQUNuQyxTQUFPLGVBQWUsU0FBUztBQUMvQixNQUFJLFVBQVU7QUFFZCxTQUFPO0FBQ1Asc0JBQW9CLE1BQU07QUFFdEIsUUFBSSxZQUFZLFlBQVksSUFBSSxZQUFZO0FB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
